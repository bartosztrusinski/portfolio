<form action='https://api.web3forms.com/submit' method='POST' class='space-y-5'>
  <div class='flex flex-col gap-5 sm:flex-row'>
    <div class='flex grow flex-col gap-1'>
      <label for='name'>Name</label>
      <input
        type='text'
        id='name'
        name='name'
        autocomplete='name'
        placeholder='John Doe'
        class='input'
        required
      />
    </div>
    <div class='flex grow flex-col gap-1'>
      <label for='email'>Email address</label>
      <input
        type='email'
        id='email'
        name='email'
        autocomplete='email'
        placeholder='john@doe.com'
        class='input'
        required
      />
    </div>
  </div>

  <div class='flex grow flex-col gap-1'>
    <label for='message'>Message</label>
    <textarea
      id='message'
      name='message'
      rows='3'
      maxlength='500'
      class='input min-h-24'
      style='field-sizing: content;'
      required></textarea>
  </div>

  {/* Access Key */}
  <input type='hidden' name='access_key' value='53c17700-c53f-4dee-b0b4-83cc7ee7d51c' />

  {/* Honeypot Spam Protection */}
  <input type='checkbox' name='botcheck' class='hidden' />

  {/* Email subject */}
  <input type='hidden' name='subject' value='Contact Message' />

  {/* Email from name */}
  <input type='hidden' name='from_name' value='Portfolio' />

  {/* Redirect URL */}
  <input type='hidden' name='redirect' value={`${Astro.url}thank-you`} />

  <button type='submit' class='btn ms-auto block w-full sm:w-max'>Send message</button>
</form>

<script>
  import { toast } from '@/lib/toaster';
  import { ButtonStateManager } from '@/lib/button-state-manager';

  const form = document.querySelector('form')!;
  const buttonEl = form.querySelector('button')!;
  const button = new ButtonStateManager(buttonEl, 'Sending...');

  form.addEventListener('submit', async (event) => {
    event.preventDefault();

    toast('Sending message, please wait...');
    button.setState('loading');

    try {
      const response = await sendMessage();
      const data = await response.json();

      if (response.status !== 200) {
        throw new Error(data?.message ?? `An error occurred: ${response.status}`);
      }

      toast.success('Message sent successfully!');
      form.reset();
    } catch (error) {
      console.error(error);
      toast.error('Something went wrong, please try again');
    } finally {
      button.setState('default');
    }
  });

  async function sendMessage() {
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    const serializedData = JSON.stringify(data);

    const response = await fetch(form.action, {
      method: form.method,
      headers: {
        'Content-Type': 'application/json',
        Accept: 'application/json',
      },
      body: serializedData,
    });

    return response;
  }
</script>
