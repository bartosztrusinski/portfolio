<p
  id='toast'
  class='fixed left-1/2 top-4 min-h-[3.125rem] w-max max-w-[min(100%-2rem,24rem)] -translate-x-1/2 text-wrap rounded border border-slate-200 bg-slate-50 px-6 py-3 text-start font-semibold shadow-lg sm:bottom-4 sm:left-auto sm:right-4 sm:top-auto sm:transform-none'>
</p>
<form action='https://api.web3forms.com/submit' method='POST' class='space-y-5'>
  <div class='flex flex-col gap-5 sm:flex-row'>
    <div class='flex grow flex-col gap-1'>
      <label for='name'>Name</label>
      <input
        type='text'
        id='name'
        name='name'
        autocomplete='name'
        placeholder='John Doe'
        class='rounded-sm px-2 py-1'
        required
      />
    </div>
    <div class='flex grow flex-col gap-1'>
      <label for='email'>Email address</label>
      <input
        type='email'
        id='email'
        name='email'
        autocomplete='email'
        placeholder='john@doe.com'
        class='rounded-sm px-2 py-1'
        required
      />
    </div>
  </div>

  <div class='flex grow flex-col gap-1'>
    <label for='message'>Message</label>
    <textarea
      id='message'
      name='message'
      rows='3'
      maxlength='500'
      class='min-h-24 rounded-sm px-2 py-1'
      style='field-sizing: content;'
      required></textarea>
  </div>

  {/* Access Key */}
  <input type='hidden' name='access_key' value='53c17700-c53f-4dee-b0b4-83cc7ee7d51c' />

  {/* Honeypot Spam Protection */}
  <input type='checkbox' name='botcheck' class='hidden' />

  {/* Email subject */}
  <input type='hidden' name='subject' value='Contact Message' />

  {/* Email from name */}
  <input type='hidden' name='from_name' value='Portfolio' />

  {/* Redirect URL */}
  <input type='hidden' name='redirect' value={`${Astro.url}success`} />

  <button
    type='submit'
    class='ms-auto block w-full min-w-36 rounded bg-primary px-4 py-2 font-semibold disabled:cursor-not-allowed disabled:opacity-50 sm:w-max'>
    Send message
  </button>
</form>

<script>
  import { useToaster } from '@/lib/toaster';
  import { useButtonStateManager } from '@/lib/button-state-manager';

  const toastEl = document.querySelector('#toast')!;
  const form = document.querySelector('form')!;
  const buttonEl = form.querySelector('button')!;

  const toast = useToaster(toastEl);
  const button = useButtonStateManager(buttonEl, 'Sending...');

  form.addEventListener('submit', async (event) => {
    event.preventDefault();

    toast('Sending message, please wait...');
    button.setState('loading');

    try {
      const response = await sendMessage();
      const data = await response.json();

      if (response.status !== 200) {
        throw new Error(data?.message ?? `An error occurred: ${response.status}`);
      }

      toast.success('Message sent successfully!');
      form.reset();
    } catch (error) {
      console.error(error);
      toast.error('Something went wrong, please try again.');
    } finally {
      button.setState('default');
    }
  });

  async function sendMessage() {
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    const serializedData = JSON.stringify(data);

    const response = await fetch(form.action, {
      method: form.method,
      headers: {
        'Content-Type': 'application/json',
        Accept: 'application/json',
      },
      body: serializedData,
    });

    return response;
  }
</script>
